<!DOCTYPE html>
<html>
	<head>
		<title>Stock Clock</title>
		<link rel="stylesheet" href="./flipclock.css">
		<script src="./jquery.min.js"></script>
		<script src="./flipclock.js"></script>		
		<script src="./screenfull.js"></script>		

		<style>
			* { padding: 0; margin: 0; }

			a { 
				color: #000;
				text-decoration:none; 
			}

			html,body {
				width: 100%;
				height: 100%;
				overflow: hidden;
				background: #000;

				display: flex;
				align-items: center;
				justify-content: center;

				user-select:none;
				color: #222;
				font-size: 1em;
				font-weight: bold;
				letter-spacing: 2px;
			}

			.flip-clock-wrapper {
				zoom:3.0; 
				display:inline-block;
			}

			.flip-clock-wrapper ul li a div div.inn {
				color: #fff;
				font-size: 1em;
			}

			.flip-clock-dot {
				display: inline-block !important;
				position: unset;
				left: unset;
				margin: 4em 0em;
				background: #fff !important;
			}

			#screenfull {
				position: fixed;
				bottom: 3em;
				right: 3em;
				width: 30px;
				height: 30px;
				background: #000 url('./full-screen.png') no-repeat;
				background-size:cover;
			}

			#copyright {
				position: fixed;
				bottom: 3em;
				width: 100%;
				height: 30px;
				text-align: center;
			}

			.nav {
				position: fixed;
				top: 3em;
				right: 3em;
				height: 30px;
				text-align: right;
			}

			.nav li {
				display: inline-block;
				margin: 0px 10px;
			}

			.nav li:hover, #copyright a:hover {
				color: #FFF;
			}

			.green {
				background-color: #89E7B3;
			}

			.red {
				background-color: #FFA4A4;
			}

			@media screen and (max-width:1400px) {
				.flip-clock-wrapper {
					zoom:2.0 !important; 
				}

				#screenfull { display: none; } 
			}
		</style>
	</head>

	<body>

		<div class="container">
			<div class="integer"></div>
			<div class="flip-clock-dot"></div>
			<div class="decimal"></div>
		</div>

		<ul class="nav">
			<li target="sh000001" onclick="location.hash='#sh000001';"> SH000001 </li>
			<li target="usr_$dji" onclick="location.hash='#usr_$dji';"> DJIA </li>			
			<li target="hf_CHA50CFD" onclick="location.hash='#hf_CHA50CFD';"> A50 </li>			

			<li class="select"></li>			
		</ul>

		<div id="copyright"> <a href="http://neil-pan.com" target="_blank" title="wx: neil-pan-s">© Neil Pan</a> </div>
		<div id="screenfull"></div>
		<div id="scripts"></div>

		<script>
			async function injectScript(src, cb, el) { 
				return new Promise((resolve) => {
					var e = document.createElement('script'); 
					e.type = 'text/javascript'; 
					e.src = src; 
					e.onload = () => { 
						resolve() 
						cb && cb() 
					}
					(el || document.body).appendChild(e) 
				})
			}
		</script>

		<script type="text/javascript">			
			var target = location.hash.replace('#', '') || 'sh000001'

			const names = {
				'usr_$dji': 'DJIA', 
				'hf_CHA50CFD': 'A50',
			}
			
			// Instantiate a counter
			let integer = new FlipClock($('.integer'), '0000', {
				clockFace: 'Counter',
				minimumDigits: 4,
			});
			
			let decimal = new FlipClock($('.decimal'), '00', {
				clockFace: 'Counter',
			});
			
			$(document).ready(function() {

				$('#screenfull').click(function (){ 
					if (screenfull.isEnabled) { screenfull.toggle($('body')[0]); }
				})

				$('.nav li').click(function () {
					if (!$(this).attr('target')) { return }

					target = $(this).attr('target')
									
					integer = new FlipClock($('.integer'), '0000', {
						clockFace: 'Counter',
						minimumDigits: 4,
					});
					
					decimal = new FlipClock($('.decimal'), '00', {
						clockFace: 'Counter',
					});
					
					$('.nav .select').html(`<span style="color: #FFF;">${ (names[target] || target).toUpperCase() }</span>`)
				})
				$('.nav .select').html(`<span style="color: #FFF;">${ (names[target] || target).toUpperCase() }</span>`)

				setInterval(async () => {

					$('#scripts').empty()

					const url = `https://hq.sinajs.cn/list=${target}`

					// JSONP : 
					// 
					//  var hq_str_sh000001="上证指数,2835.5840,2846.2217,2852.3512,2855.3756,2829.6271,0,0,206792804,233798996643,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2020-05-29,15:02:10,00,";
					//	1：2835.5840 - 今日开盘价
					//	2：2846.2217 - 昨日收盘价
					//	3：2852.3512 - 当前价格
					//	4：2855.3756 - 今日最高价
					//	5：2829.6271 - 今日最低价
					// 
					//  var hq_str_usr_$dji="道琼斯,25383.1094,-0.07,2020-05-30 05:14:07,-17.5300,25324.1504,25482.8008,25031.6699,29568.5703,18213.6504,545144765,410292795,0,0.00,--,0.00,0.00,0.00,0.00,0,0,0.0000,0.00,0.0000,,May 29 05:14PM EDT,25400.6406,0,1,2020";
					//  1: 25383.1094 - 当前价格
					//  5: 25324.1504 - 今日开盘价
					//  6: 25482.8008 - 今日最高价
					//  7: 25031.6699 - 今日最低价
					//  8: 29568.5703 - 52周最高价
					//  9: 18213.6504 - 52周最低价
					// 26: 25400.6406 - 昨日收盘价
					// 
					//  var hq_str_hf_CHA50CFD="13212.000,,13210.000,13217.500,13230.000,13045.000,05:14:25,13195.000,13187.500,635583.000,16,2,2020-05-30,富时中国A50指数,60041";
					//  0: 13212.000 - 当前价格
					//  2: 13210.000 - 买价
					//  3: 13217.500 - 卖价
					//  4: 13230.000 - 今日最高价
					//  5: 13045.000 - 今日最低价
					//  7: 13195.000 - 昨日收盘价
					injectScript(url, () => {

						try {
							const hq_str_variable = window[`hq_str_${target}`]

							if (!hq_str_variable) { return }

							var now = 0, preclose = 0, __integer = 0, __decimal = 0
							var sections = hq_str_variable.split(',')

							if (target === 'usr_$dji') {
								preclose = +sections[26]
								now = +sections[1]

								__integer = +sections[1].split('.')[0]
								__decimal = +((+sections[1]).toFixed(2).split('.')[1])

								$('.flip-clock-wrapper').css('zoom', '2.5')

							} else if (target === 'hf_CHA50CFD') {

								preclose = +sections[7]
								now = +sections[0]

								__integer = +sections[0].split('.')[0]
								__decimal = +((+sections[0]).toFixed(2).split('.')[1])

								$('.flip-clock-wrapper').css('zoom', '2.5')

							} else {
								preclose = +sections[2]
								now = +sections[3]

								__integer = +sections[3].split('.')[0]
								__decimal = +((+sections[3]).toFixed(2).split('.')[1])

								$('.flip-clock-wrapper').css('zoom', '3.0')
							}

							integer.setTime(`${__integer}`)
							decimal.setTime(`${__decimal}`)

							if (now > preclose) {
								$('.flip-clock-wrapper ul li a div div.inn').css('color', '#FFA4A4')
							} else if (now < preclose) {
								$('.flip-clock-wrapper ul li a div div.inn').css('color', '#89E7B3')
							} else {
								$('.flip-clock-wrapper ul li a div div.inn').css('color', '#FFFFFF')
							}

						} catch {

						}
					}, document.querySelector('#scripts'))
				}, 3000)
			});
		</script>
		
	</body>
</html> 