
<!-- Requied URL Query Param : collection 数据目录, name 榜单名  -->

<!doctype html>
<html>

<head>
	<title>Walle Trace Chart</title>
	<script src="./lib/Chart.min.js"></script>
	<script src="./lib/url.js"></script>
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
	<div style="width:90%; margin:auto;">
		<canvas id="canvas"></canvas>
	</div>
	<br>
	<br>
	<script>
		window.chartColors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};

		var chartsInstance
		var chartsData

		function handleDailyOrHistotyChartsData(datas) {
			let labels = []
			let data = {
				'ptcchange': [],
				'profit': [],
			}
			let profit = 0

			let length = datas['daily-ptcchange'].length

			for (let index = length - 1; index >= 0; index--) {
				let item = datas['daily-ptcchange'][index]

				if (index%2 == 0) {
					labels.push(item)
				} else {
					profit += datas['daily-ptcchange'][index]
					data['ptcchange'].push(datas['daily-ptcchange'][index])
					data['profit'].push(datas['daily-profit'][index])
				}
			}

			return {
				labels,
				datas: data,
				profit,
			}
		}

		function handleTodayChartsData(datas) {
			return {
				labels: datas.time,
				datas: { ptcchange: datas.data },
				profit: datas.data[datas.data.length-1],
			}
		}

		function loadCharts(datas) {
			chartsData = (url('?mode') === 'today-trace') ? handleTodayChartsData(datas) : handleDailyOrHistotyChartsData(datas)

			var config = {
				type: 'line',
				data: {
					labels: chartsData.labels,
					datasets: [
						{
							label: `Stocks PTC-Change`,
							backgroundColor: window.chartColors.red,
							borderColor: window.chartColors.red,
							data: chartsData.datas.ptcchange,
							fill: false,
						}, 
						{
							label: 'Stocks Total Profit',
							fill: false,
							backgroundColor: window.chartColors.blue,
							borderColor: window.chartColors.blue,
							data: chartsData.datas.profit,
						}
					]
				},
				options: {
					responsive: true,
					title: {
						display: true,
						text: `Walle Trace Chart (%${(+chartsData.profit).toFixed(2)})`
					},
					tooltips: {
						mode: 'index',
						intersect: false,
					},
					hover: {
						mode: 'nearest',
						intersect: true
					},
					scales: {
						xAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'DateTime'
							}
						}],
						yAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'PTC Change'
							}
						}]
					}
				}
			};

			var ctx = document.getElementById('canvas').getContext('2d');
			if (chartsInstance) { chartsInstance.destroy() }
			chartsInstance = new Chart(ctx, config)
		}

		window.__Walle_Charts_Callback = function (data) {
			console.log('#Charts __Walle_Charts_Callback# ', data)

			chartsData = data
			loadCharts(data)
		}

		function injectScript(src) { 
			var e = document.createElement('script'); 
			e.type = 'text/javascript'; 
			e.src = src; 
			document.body.appendChild(e) 
		}

		(function() {
			// collection mode 
			var collectionDir = url('?collection')
			if (collectionDir) {
				const collectionListJs = `${collectionDir}/${ url('?name') || '资金净流入榜' }.js`
				injectScript(collectionListJs)
			}
		})()
	</script>
</body>

</html>
