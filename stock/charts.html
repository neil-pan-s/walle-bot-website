
<!-- Requied URL Query Param : collection 数据目录, name 榜单名  -->

<!doctype html>
<html>

<head>
	<title>Walle Trace Chart</title>
	<script src="./lib/Chart.min.js"></script>

	<!-- chratjs zoom 插件 [deprecated] 使用体验不佳 -->
	<!-- <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
	<script src="https://npmcdn.com/Chart.Zoom.js@latest/Chart.Zoom.min.js"></script> -->

	<script src="./lib/url.js"></script>
	<style>
	* {
		padding: 0;
		margin: 0;
	}	

	#title {
		text-align: center;
		font-size: 15px;
		cursor: pointer;
		display: none;
	}

	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
	<div style="width:90%; margin:auto;">
		<div id="title">Walle Trace Chart</div>
		<canvas id="canvas"></canvas>
	</div>
	<br>
	<br>
	<script>
		window.chartColors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};

		var chartsInstance
		var chartsData

		function handleDailyOrHistotyChartsData(datas) {
			let labels = []
			let data = {
				'daily-close-ptcchange': [],
				'daily-close-profit': [],
				'daily-open-ptcchange': [],
				'daily-open-profit': [],				
			}

			for (let index in datas['daily-close-ptcchange']) {
				if (index%2 == 0) {
					let date = datas['daily-close-ptcchange'][index]
					labels.push(date)
				} else {
					data['daily-close-ptcchange'].push(datas['daily-close-ptcchange'][index])

					if(datas['daily-close-profit']) {
						data['daily-close-profit'].push(datas['daily-close-profit'][index])
					}
					if(datas['daily-open-ptcchange']) {
						data['daily-open-ptcchange'].push(datas['daily-open-ptcchange'][index])
					}
					if(datas['daily-open-profit']) {
						data['daily-open-profit'].push(datas['daily-open-profit'][index])
					}
				}
			}

			return {
				labels,
				datasets: [
					{
						label: `Stocks PTCChange-Close`,
						backgroundColor: window.chartColors.blue,
						borderColor: window.chartColors.blue,
						data: data['daily-close-ptcchange'],
						fill: false,
					}, 
					{
						label: 'Stocks Total Profit-Close',
						fill: false,
						backgroundColor: window.chartColors.red,
						borderColor: window.chartColors.red,
						data: data['daily-close-profit'],
					},
					{
						label: `Stocks PTCChange-Open`,
						backgroundColor: window.chartColors.yellow,
						borderColor: window.chartColors.yellow,
						data: data['daily-open-ptcchange'],
						fill: false,
					}, 
					{
						label: 'Stocks Total Profit-Open',
						fill: false,
						backgroundColor: window.chartColors.orange,
						borderColor: window.chartColors.orange,
						data: data['daily-open-profit'],
					}					
				]
			}
		}

		function handleTodayChartsData(datas) {
			return {
				labels: datas.time,
				datasets: [
					{
						label: `Stocks PTC-Change`,
						backgroundColor: window.chartColors.red,
						borderColor: window.chartColors.red,
						data: datas.data,
						fill: false,
					}
				]
			}
		}

		function loadCharts(datas) {
			chartsData = (url('?mode') === 'today-trace') ? handleTodayChartsData(datas) : handleDailyOrHistotyChartsData(datas)

			var config = {
				type: 'line',
				data: {
					labels: chartsData.labels,
					datasets: chartsData.datasets,
				},
				options: {
					responsive: true,
					title: {
						display: true,
						// text: `Walle Trace Chart`
					},
					tooltips: {
						mode: 'index',
						intersect: false,
					},
					hover: {
						mode: 'nearest',
						intersect: true
					},
					scales: {
						xAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'DateTime'
							}
						}],
						yAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'PTC Change'
							}
						}]
					},	
					// Container for pan options
					pan: {
						// Boolean to enable panning
						enabled: true,

						// Panning directions. Remove the appropriate direction to disable 
						// Eg. 'y' would only allow panning in the y direction
						mode: 'xy'
					},


					// Container for zoom options
					zoom: {
						// Boolean to enable zooming
						enabled: true,

						// Zooming directions. Remove the appropriate direction to disable 
						// Eg. 'y' would only allow zooming in the y direction
						mode: 'xy'
					}		
				},
			};

			var ctx = document.getElementById('canvas').getContext('2d');
			if (chartsInstance) { chartsInstance.destroy() }
			chartsInstance = new Chart(ctx, config)
		}

		function createTitleInfo(data) {
			var title = document.querySelector('#title')
			var info = {
				name: data.name,
				profit: data.profit,
				day: data.day
			}

			if (data.name) {
				title.style.display = 'block'
				title.setAttribute('title', JSON.stringify(info, null, 4))
			}
		}

		window.__Walle_Charts_Callback = function (data) {
			// console.log('#Charts __Walle_Charts_Callback# ', data)

			if (data) {				
				chartsData = data

				loadCharts(data)
				createTitleInfo(data)
			}
		}

		function injectScript(src) { 
			var e = document.createElement('script'); 
			e.type = 'text/javascript'; 
			e.src = src; 
			document.body.appendChild(e) 
		}

		(function() {
			// collection mode 
			var collectionDir = url('?collection')
			if (collectionDir) {
				const collectionListJs = `${collectionDir}/${ url('?name') }.js`
				injectScript(collectionListJs)
			}
		})()
	</script>
</body>

</html>
