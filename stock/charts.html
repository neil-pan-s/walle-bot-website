
<!-- Requied URL Query Param : collection 数据目录, name 榜单名  -->

<!doctype html>
<html>

<head>
	<title>Walle Trace Chart</title>
	<script src="./lib/Chart.min.js"></script>
	<script src="./lib/url.js"></script>
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
	<div style="width:90%; margin:auto;">
		<canvas id="canvas"></canvas>
	</div>
	<br>
	<br>
	<script>
		window.chartColors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};

		var chartsInstance
		var chartsData

		function handleDailyOrHistotyChartsData(datas) {
			let labels = []
			let data = {
				'daily-close-ptcchange': [],
				'daily-close-profit': [],
				'daily-open-ptcchange': [],
				'daily-open-profit': [],				
			}

			let length = datas['daily-close-ptcchange'].length

			for (let index = length - 1; index >= 0; index--) {
				if (index%2 == 0) {
					let date = datas['daily-close-ptcchange'][index]
					labels.push(date)
				} else {
					data['daily-close-ptcchange'].push(datas['daily-close-ptcchange'][index])
					data['daily-close-profit'].push(datas['daily-close-profit'][index])
					
					if(datas['daily-open-ptcchange']) {
						data['daily-open-ptcchange'].push(datas['daily-open-ptcchange'][index])
					}
					if(datas['daily-open-profit']) {
						data['daily-open-profit'].push(datas['daily-open-profit'][index])
					}
				}
			}

			return {
				labels,
				datasets: [
					{
						label: `Stocks PTCChange-Close`,
						backgroundColor: window.chartColors.blue,
						borderColor: window.chartColors.blue,
						data: data['daily-close-ptcchange'],
						fill: false,
					}, 
					{
						label: 'Stocks Total Profit-Close',
						fill: false,
						backgroundColor: window.chartColors.red,
						borderColor: window.chartColors.red,
						data: data['daily-close-profit'],
					},
					{
						label: `Stocks PTCChange-Open`,
						backgroundColor: window.chartColors.yellow,
						borderColor: window.chartColors.yellow,
						data: data['daily-open-ptcchange'],
						fill: false,
					}, 
					{
						label: 'Stocks Total Profit-Open',
						fill: false,
						backgroundColor: window.chartColors.orange,
						borderColor: window.chartColors.orange,
						data: data['daily-open-profit'],
					}					
				]
			}
		}

		function handleTodayChartsData(datas) {
			return {
				labels: datas.time,
				datasets: [
					{
						label: `Stocks PTC-Change`,
						backgroundColor: window.chartColors.red,
						borderColor: window.chartColors.red,
						data: datas.data,
						fill: false,
					}
				]
			}
		}

		function loadCharts(datas) {
			chartsData = (url('?mode') === 'today-trace') ? handleTodayChartsData(datas) : handleDailyOrHistotyChartsData(datas)

			var config = {
				type: 'line',
				data: {
					labels: chartsData.labels,
					datasets: chartsData.datasets,
				},
				options: {
					responsive: true,
					title: {
						display: true,
						text: `Walle Trace Chart`
					},
					tooltips: {
						mode: 'index',
						intersect: false,
					},
					hover: {
						mode: 'nearest',
						intersect: true
					},
					scales: {
						xAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'DateTime'
							}
						}],
						yAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'PTC Change'
							}
						}]
					}
				}
			};

			var ctx = document.getElementById('canvas').getContext('2d');
			if (chartsInstance) { chartsInstance.destroy() }
			chartsInstance = new Chart(ctx, config)
		}

		window.__Walle_Charts_Callback = function (data) {
			console.log('#Charts __Walle_Charts_Callback# ', data)

			chartsData = data
			loadCharts(data)
		}

		function injectScript(src) { 
			var e = document.createElement('script'); 
			e.type = 'text/javascript'; 
			e.src = src; 
			document.body.appendChild(e) 
		}

		(function() {
			// collection mode 
			var collectionDir = url('?collection')
			if (collectionDir) {
				const collectionListJs = `${collectionDir}/${ url('?name') || '资金净流入榜' }.js`
				injectScript(collectionListJs)
			}
		})()
	</script>
</body>

</html>
