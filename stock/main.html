
<!-- [重要] file协议载入 浏览器由于安全限制 会禁止iframe显示 注意关闭浏览器的安全限制 -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>::: Walle Stocks Center :::</title>
  <script src="./lib/url.js"></script>
  <script src="./lib/moment.min.js"></script>
  <script src="./lib/popper.min.js"></script>
  <script src="./lib/tooltip.min.js"></script>
  <link rel="stylesheet" href="./lib/popper.css" />
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    html,body {
      width: 100%;
      height: 110%;

      color: #1d1f21;
      font-size: 17px;
      font-family: "Menlo", "Meslo LG", "Microsoft Yahei", monospace;
      font-weight: 400;
    }

    iframe {
      width: 90%;
      height: 90%;
      margin: auto;
      display: block;
    }

    ul {
      list-style: none;
      text-align: center;
      padding: 20px;
      width: 80%;
      margin: auto;
    }

    li {
      text-align: center;
      display: inline-block;
      padding: 5px 15px;
    }

    li.selected {
      color:rgb(255, 99, 132);
    }
   
    li:hover {
      color:rgb(255, 99, 132);
      transition: color 0.3s linear, background-color 0.3s linear;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .without {
      text-decoration: line-through;
    }

    #nav {
      width: 80%;
    }

    #nav a:hover {
      border-bottom: #000 dotted 1px;
    }

    #types li{
      cursor: pointer;
    }

    #mask {
      background: #fff;
      opacity: 0.5;
      display: none;
      align-items:center;
      justify-content:center;
      font: 48px;
      font-weight: bold;

      position: fixed;
      top: 10%;
      left: 0;
      width: 100%;
      height: 80%;
    }

    .tooltip {
      background: #FFC107;
      color: #fff;
      width: auto;
      /* max-width: 70%; */
      box-shadow: none;
    }

    .tooltip .table {
      font-size: 12px;
      margin-top: 10px;
    }

    .tooltip .table th {
      min-width: 100px;
    }    

    .tooltip .table .tbody {
      font-weight: 300;
    }

    .toast-title, .toast-message {
      font-size: 12px;
    }

    .toast-message {
      padding-top: 5px;
    }

  </style>
</head>
<body>

  <div id="mask"> Walle Stock Market </div>

  <ul id="switch">
    <li id="today-trace"  class="selected"><a href="?mode=today-trace">今日数据</a></li>
    <li id="daily-trace"><a href="?mode=daily-trace">近期跟踪</a></li>
    <li id="history-trace"><a href="?mode=history-trace">历史数据</a></li>
  </ul>
  
  <ul id="types"></ul>

  <ul id="nav"></ul>
  <iframe id="charts" src="" frameborder="0" scrolling="no"></iframe>

  <script>
    var mode = url('?mode') || 'today-trace'
    var collections = {
      // 访问地址 ?mode=history-trace-with-limit-up-sotcks
      // 捕获榜单包含涨停股 但无法买入操作 追踪数据计算收益有偏差(偏大很多)
      'history-trace-with-limit-up-sotcks': './collections/history-trace-with-limit-up-stocks/',
      // 访问地址 ?mode=history-trace-without-limit-up-sotcks
      // 捕获榜单不包含涨停股 接近实际买入操作
      'history-trace-without-limit-up-sotcks': './collections/history-trace-without-limit-up-stocks/',

      'history-trace': './collections/history-trace/',
      'daily-trace': './collections/daily-trace/',
    }
    var dailyListsChange = {}
    var dailyListsCapture = {}

    var dailyListsChangeMap = {
      // [09:40]: { ...dailyListsChange },
      // [14:40]: { ...dailyListsChange },
    }
    var dailyListsCaptureMap = {
      // [09:40]: { ...dailyListsCapture },
      // [14:40]: { ...dailyListsCapture },
    }

    var mask = document.getElementById('mask')
    var iframe = document.getElementById('charts')
    var interval = 0
    var toolTip = null

    var config = {}
    var captureTimeSelected = ''
    var dailyNavSelected = ''
    
    // 前两个交易日数据
    var last1dayChanges = {}
    var last2dayChanges = {}

    var isDev = location.host.includes('localhost') || location.host.includes('127.0.0.1')

    function showMask(msg) {
      mask.style.display = 'flex'
      msg && (maks.innerHTML = msg)
    }

    function hideMask() {
      mask.style.display = 'none'
    }

    async function initWalleStockDevTool() {      
      if ( isDev ) {
        // dev use , 2 mins 
        interval = window.__Walle_Stock_Interval_Capture_Start( 2 * 60 )
      } else {
        // production use , default 5 min
        interval = window.__Walle_Stock_Interval_Capture_Start()
      }
    }

    async function initWalleStockData() {
      var date = moment().format('YYYYMMDD')
      
      // 保留前一周数据 用于复盘分析
      // var lastdate = moment().subtract(1, 'day').format('YYYYMMDD')
      var lastdate = moment().subtract(7, 'days').format('YYYYMMDD')

      localStorage.removeItem(`__Walle_Stock_Daily_Trace_${lastdate}`)
      localStorage.removeItem(`__Walle_Stock_Daily_Capture_${lastdate}`)

      var sdailyListsChange = await localStorage.getItem(`__Walle_Stock_Daily_Trace_${date}`) 
      if (sdailyListsChange) {
        dailyListsChangeMap = JSON.parse(sdailyListsChange)
      }

      var sTodayCaptureLists = await localStorage.getItem(`__Walle_Stock_Daily_Capture_${date}`) 
      if (sTodayCaptureLists) {
        dailyListsCaptureMap = JSON.parse(sTodayCaptureLists)
      }
      
      switchDataWithCaptureTime()
      if (dailyListsChangeMap[captureTimeSelected]) {
        buildTodayNav()
        hideMask()
      }

      console.log('@initWalleStockDevTool@ Trace ', dailyListsChangeMap)
      console.log('@initWalleStockDevTool@ Capture ', dailyListsCaptureMap)
      console.log('@captureTimeSelected@' , captureTimeSelected)
      console.log('@dailyNavSelected@' , dailyNavSelected)

      isDev &&  hideMask()
    }

    function onSwitchToday() {
      showMask()
      iframe.src=`./charts.html?mode=today-trace`
      iframe.onload = initWalleStockData

      if ( isDev ) {
        // debug use 
        injectScript(`${location.origin}/walle-stock.min.js`,initWalleStockDevTool)
      } else {
        // production use 
        injectScript('../walle-stock.min.js',initWalleStockDevTool)
      }

      window.addEventListener('__Walle_Stock_Daily_Capture_Event', async function ({ detail }) {
        console.log('#__Walle_Stock_Daily_Capture_Event# ', detail)
        var date = moment().format('YYYYMMDD')

        var captureTime = detail.time
        dailyListsCaptureMap[captureTime] = detail.lists 
        await localStorage.setItem(`__Walle_Stock_Daily_Capture_${date}`, JSON.stringify(dailyListsCaptureMap))

        switchDataWithCaptureTime()
      })

      window.addEventListener('__Walle_Stock_Daily_Trace_Event', async function ({ detail }) {
        var time = moment().format('HH:mm:ss')
        var date = moment().format('YYYYMMDD')
        console.log('#__Walle_Stock_Daily_Trace_Event# ', time, detail)

        var captureTime = detail.time
        // every day reset dailyListsChange
        if (dailyListsChangeMap.date !== date) {
          dailyListsChangeMap = {
            date, 
            [captureTime]: {
              changes: {},
              newlists: {},
              oldlists: {},
            }
          }
        }

        if (!dailyListsChangeMap[captureTime]) {
          dailyListsChangeMap[captureTime] = {
            changes: {},
            newlists: {},
            oldlists: {},
          }
        }

        var data = detail.changes
        var keys = Object.keys(data)
        for (var list_name of keys) {
          var value = data[list_name]

          if (!dailyListsChangeMap[captureTime].changes[list_name]) { 
            dailyListsChangeMap[captureTime].changes[list_name] = {
              time: [time],
              data: [value]
            }
          } else {
            dailyListsChangeMap[captureTime].changes[list_name].time.push(time)
            dailyListsChangeMap[captureTime].changes[list_name].data.push(value)
          }
        }

        dailyListsChangeMap[captureTime].newlists = detail.newlists
        dailyListsChangeMap[captureTime].oldlists = detail.oldlists

        console.log(`#__Walle_Stock_Daily_Trace_${date}# `, dailyListsChangeMap)
        await localStorage.setItem(`__Walle_Stock_Daily_Trace_${date}`, JSON.stringify(dailyListsChangeMap))

        switchDataWithCaptureTime()
        buildTodayNav()
        hideMask()
      }) 
    }

    function onChangeTodayCharts(name) {
      if (!dailyListsChange) { 
        // clear chart
        if(iframe.contentWindow.window.__Walle_Charts_Callback) { 
          iframe.contentWindow.window.__Walle_Charts_Callback({ time:[], data: [] })
        }
        return 
      }

      dailyNavSelected = name
      var nav = document.getElementById('nav')
      
      var liSelected = document.querySelector('#nav li.selected')
      if (liSelected) { liSelected.removeAttribute('class') }
      var el = document.querySelector(`#nav li[name="${name}"]`)
      el && el.setAttribute('class', 'selected')

      console.log('#call __Walle_Charts_Callback# ', dailyNavSelected, dailyListsChange.changes[dailyNavSelected])
      iframe.contentWindow.window.__Walle_Charts_Callback(dailyListsChange.changes[dailyNavSelected])
    }

    function createStocksTable(list, name) {
      var translator = {
        code: '股票代码',
        name: '股票简称',
        price: '股价',
        zdf: '涨跌幅',
        rate: '主力净占比',
        kpj: '开盘价',
        hsl: '换手率',
        cjl: '成交量',
        lrzj: '主力流入资金',
        lczj: '主力流出资金',
        je: '主力净流入资金',
        ddlr: '主力大单流入',
      }

      if (!list[name]) { return }

      var stockCodes = Object.keys(list[name])

      var table = '<table class="table">'

      var thead = `<thead><tr>`
      var fieldKeys = list[name][stockCodes[0]]
      for (var key in fieldKeys) {
        thead += `<th scope="col">${translator[key]}</th>`
      }
      thead += '</tr></thead>'

      var tbody = `<tbody>`
      for (var code of stockCodes) {
        var stock = list[name][code]
        tbody += `<tr>`
        for (var field in fieldKeys ) {
          tbody += `<th scope="row">${stock[field]}</th>`
        }
        tbody += '</tr>'
      }  
      tbody += `</tbody>`

      table += thead + tbody + '</table>'

      return table
    }

    async function onHoverTodayCharts(el, name, isTodayCaptureList = false) {
      var title = ''

      if (isTodayCaptureList) {
        if(!dailyListsCapture) { return }

        // [deprecated] - 20191111 不再通过 'Ξ' 查看今日捕获的榜单, 在 'T0-xx:xx' 直接查看
        if(dailyListsCapture[name]) {
          // 今日捕获数据
          var listTable = createStocksTable(dailyListsCapture, name)
          title = `捕获${listTable}<br/>`    
        }    
      } else {
        if (!dailyListsChange) { return }

        // 昨日追踪数据
        var newListTable = createStocksTable(dailyListsChange.newlists, name)
        var oldListTable = createStocksTable(dailyListsChange.oldlists, name)

        if (captureTimeSelected && captureTimeSelected.startsWith('t0')) {
          title = `跟踪${newListTable}<br/>捕获${oldListTable}`        
        } else {
          title = `今日${newListTable}<br/>昨日${oldListTable}`        
        }
      }

      toolTip && toolTip.dispose()
      toolTip = new Tooltip(el, {
        title,
        html: true,
        delay: { show: 1000, hide: 300 },
        popperOptions: {
          placement: 'bottom',
          modifiers: {
            preventOverflow: {
              boundariesElement: document.querySelector('body'),
            },
          },
        },
      });

      return false
    }

    function indicatorOfTodayNav(time, name) {
      if (!captureTimeSelected.startsWith('t0')) { return ''}

      if (last1dayChanges[time] && last2dayChanges[time]) {
        if (last1dayChanges[time].changes && last2dayChanges[time].changes) {
          if (last1dayChanges[time].changes[name] && last2dayChanges[time].changes[name]) {
            const last1dayChange = +last1dayChanges[time].changes[name].data.slice(-1)
            const last2dayChange = +last2dayChanges[time].changes[name].data.slice(-1)

            // 连续两日榜单追踪为下跌则标记为不买入
            if (last1dayChange < 0 && last2dayChange < 0) {
              return `<i title="前两交易日跟踪收益: ${last1dayChange}%,${last2dayChange}%">✘</i>`
            } else {
              return `<i title="前两交易日跟踪收益: ${last1dayChange}%,${last2dayChange}%">✔</i>`
            }
          }
        }
      }

      return ''
    }

    async function buildTodayNav() {
      var nav = document.getElementById('nav')
      if (!dailyListsChange) { 
        nav.innerHTML = ''
        onChangeTodayCharts()
        return 
      }

      var data = dailyListsChange.changes
      var names = Object.keys(data)

      var shtml = ''
      for (var name of names) {
        if (name === '跌幅榜' || name === '上证指数') { continue }
  
        var ptcchange = data[name].data[data[name].data.length - 1]
        var text = (name.slice(-1) === '榜') ? name.slice(0, -1): name

        // [deprecated] - 2019111 'Ξ' as indicator, won't show today capture list 
        // shtml += `<li name="${name}" >
        //   <a href="#" onmouseover="onHoverTodayCharts(this, '${name}', true)">Ξ</a>
        //   <a href="#" onclick="onChangeTodayCharts('${name}')">${text.toUpperCase()}</a>
        //   (<a href="#" onmouseover="onHoverTodayCharts(this, '${name}')">${ptcchange}%</a>)
        //   </li>`

        shtml += `<li name="${name}" >
          <a href="#">${indicatorOfTodayNav(captureTimeSelected, name)}</a>
          <a href="#" onclick="onChangeTodayCharts('${name}')">${text.toUpperCase()}</a>
          (<a href="#" onmouseover="onHoverTodayCharts(this, '${name}')">${ptcchange}%</a>)
          </li>`
      }

      if (data['上证指数']) {
        var index_ptcchange = data['上证指数'].data[data['上证指数'].data.length - 1]
        shtml = `<li name="上证指数" >
        <a href="#" onclick="onChangeTodayCharts('上证指数')" >上证指数</a>
        (<a href="#" onmouseover="onHoverTodayCharts(this, '上证指数')">${index_ptcchange}%</a>)
        </li>` + shtml
      }

      nav.innerHTML = shtml

      var defaultSeleted = nav.querySelector('li').getAttribute('name')
      var isExistCurSelected = dailyNavSelected && nav.querySelector(`li[name="${dailyNavSelected}"]`)
      onChangeTodayCharts(isExistCurSelected ? dailyNavSelected : defaultSeleted)
    }

    function onSwitch() {
      var liSelected = document.querySelector('#switch li.selected')
      if (liSelected) { liSelected.removeAttribute('class') }
      var el = document.querySelector(`#switch #${mode}`)
      if(el ) { el.setAttribute('class', 'selected') }

      (mode === 'today-trace') ? onSwitchToday() : onSwitchDailyOrHistory()
    }

    function onSwitchDailyOrHistory() {
      var collectionJs = `${collections[mode]}/index.js`
      injectScript(collectionJs)
    }

    async function onChangeDailyOrHistoryCharts(list_name) {
      if (!list_name) { 
        // clear chart
        if(iframe.contentWindow.window.__Walle_Charts_Callback) { 
          iframe.contentWindow.window.__Walle_Charts_Callback({ time:[], data: [] })
        }
        return 
      }

      await new Promise((resolve) => {
        iframe.src=`./charts.html?name=${list_name}&collection=${collections[mode]}`
        iframe.onload = resolve
      }) 

      var nav = document.getElementById('nav')
      
      var liSelected = document.querySelector('#nav li.selected')
      if (liSelected) { liSelected.removeAttribute('class') }
      document.querySelector(`#nav li[name="${list_name}"]`).setAttribute('class', 'selected')
    }

    async function buildDailyOrHistoryNav(names) {
      var nav = document.getElementById('nav')
      var nameOfIndex = '上证指数'
      var isExistIndex = false 

      nav.style.display = 'none'

      var shtml = ''
      for (var name of names) {
        if (name.includes('跌幅榜')) { continue }

        var text = (name.slice(-1) === '榜') ? name.slice(0, -1): name
        var sli = `<li onclick="onChangeDailyOrHistoryCharts('${name}')" name="${name}" >${text.toUpperCase()}</li>`

        // 上证指数在第一位
        if (name.includes('上证指数')) {
          nameOfIndex = name
          shtml = sli + shtml

          isExistIndex = true
        } else {
          shtml += sli
        }
      }

      if (!isExistIndex) {
        shtml = `<li onclick="onChangeDailyOrHistoryCharts('${nameOfIndex}')" name="${nameOfIndex}" >上证指数</li>` + shtml
      }

      nav.innerHTML = shtml
      if (mode !== 'daily-trace') {
        nav.style.display = 'block'
      }

      var defaultSeleted = nav.querySelector('li').getAttribute('name')
      await onChangeDailyOrHistoryCharts(defaultSeleted)
    }

    async function buildDailyNav() {
      var nav = document.getElementById('nav')
      var lis = document.querySelectorAll('#nav li') 
      var defaultSeleted = ''

      if (!lis.length) { return }

      for(var li of lis) {
        var name = li.getAttribute('name')
        var time = captureTimeSelected.replace(':','')
        if (name.includes(time)) {
          li.style.display = 'inline-block'
          
          // 0940@上证指数 => 上证指数
          if(li.innerText.includes('@')) {
            var text = li.innerText.split('@')[1]
            li.innerText = (text.slice(-1) === '榜') ? text.slice(0, -1): text
          }

          if (name.includes('上证指数')) {
            defaultSeleted = name
          }
        } else {
          li.style.display = 'none'
        }
      }
      
      nav.style.display = 'block'
      await onChangeDailyOrHistoryCharts(defaultSeleted)
    }
    
    window.__Walle_Stocks_Callback = async function (data) {
      var names = data.names.split(',')
      await buildDailyOrHistoryNav(names)

      if (mode === 'daily-trace') {
        await buildDailyNav()
      }
    }

    function injectScript(src, cb) { 
			var e = document.createElement('script'); 
			e.type = 'text/javascript'; 
      e.src = src; 
      e.onload = cb
			document.body.appendChild(e) 
		}

    function initHistoryTypeNav() {
      var nav = document.getElementById('types')

      var sHtml = ``
      if (mode === 'history-trace') {
        sHtml += `<li class="selected"><a href="?mode=history-trace">组合</a></li>`
      } else {
        sHtml += `<li><a href="?mode=history-trace">组合</a></li>`
      }
      
      if (mode === 'history-trace-without-limit-up-sotcks') {
        sHtml += `<li class="selected"><a class="without" href="?mode=history-trace-without-limit-up-sotcks" >10%</a></li>`
      } else {
        sHtml += `<li><a class="without" href="?mode=history-trace-without-limit-up-sotcks" >10%</a></li>`
      }

      if (mode === 'history-trace-with-limit-up-sotcks') {
        sHtml += `<li class="selected"><a class="with" href="?mode=history-trace-with-limit-up-sotcks" >10%</a></li>`
      } else {
        sHtml += `<li><a class="with" href="?mode=history-trace-with-limit-up-sotcks" >10%</a></li>`
      }
      
      nav.innerHTML = sHtml
    }

    async function initTimesNav() {
      var nav = document.getElementById('types')
      const rules = [].concat(config.rules, config.intervals)

      var sHtml = ''
      var sT0Html = ''
      for(var rule of rules) {
        sHtml += `<li onclick="onChangeTimesNav(this)">${rule.capture.toUpperCase()}</li>`
        sT0Html += `<li onclick="onChangeTimesNav(this)">T0-${rule.capture.toUpperCase()}</li>`
      }

      if (mode === 'today-trace') {
        nav.innerHTML = sHtml + sT0Html
      } else {
        nav.innerHTML = sHtml
      }

      onChangeTimesNav(document.querySelector('#types li:first-child'))
    }

    function onChangeTimesNav(el) {
      var lis = document.querySelectorAll('#types li')
      for(var li of lis) {
        li.removeAttribute('class', 'selected')
      }

      el.setAttribute('class', 'selected')

      captureTimeSelected = el.innerText.toLowerCase()
      switchDataWithCaptureTime()

      ;(mode === 'today-trace') ? buildTodayNav() : buildDailyNav()
    }

    function switchDataWithCaptureTime() {
      dailyListsCapture = dailyListsCaptureMap[captureTimeSelected]
      dailyListsChange = dailyListsChangeMap[captureTimeSelected]
    }

    async function loadConfig() {
      try {
        // load config 
        var sConfig = await localStorage.getItem(`localforage/__Walle_Stock_Bot_Config`) 
        config = JSON.parse(sConfig)

        // load last 2 trade days data 
        var last1day = moment().subtract(1, 'day').format('YYYYMMDD')
        var last2day = moment().subtract(2, 'days').format('YYYYMMDD')
        // 周一前两个工作日为上周周四、周五
        if (+moment().day() === 1) {
          last1day = moment().subtract(3, 'days').format('YYYYMMDD')
          last2day = moment().subtract(4, 'days').format('YYYYMMDD')
        } else if (+moment().day() === 2) {
          last2date = moment().subtract(4, 'days').format('YYYYMMDD')
        }

        var sLast1dayChanges = await localStorage.getItem(`__Walle_Stock_Daily_Trace_${last1day}`) 
        var sLast2dayChanges = await localStorage.getItem(`__Walle_Stock_Daily_Trace_${last2day}`) 
        if (sLast1dayChanges && sLast2dayChanges) {
          last1dayChanges = JSON.parse(sLast1dayChanges)
          last2dayChanges = JSON.parse(sLast2dayChanges)
        }

        captureTimeSelected = config.rules[0].capture
      } catch (e) {
        // first time load config data not loaded, reload.
        setTimeout(() => location.reload(), 1000) 
      }
    }

    window.onload = async function() {
      await loadConfig()

      if (['daily-trace', 'today-trace'].includes(mode)) {
        initTimesNav()
      } else {
        initHistoryTypeNav()
      }

      onSwitch()
    }
  </script>
</body>
</html>