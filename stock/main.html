<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>::: Walle Stocks Center :::</title>
  <script src="./lib/handlebars.min.js"></script>
  <script src="./lib/url.js"></script>
  <script src="./lib/moment.min.js"></script>
  <script src="./lib/popper.min.js"></script>
  <script src="./lib/tooltip.min.js"></script>
  <link rel="stylesheet" href="./lib/popper.css" />
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    html,body {
      width: 100%;
      height: 110%;

      color: #1d1f21;
      font-size: 17px;
      font-family: "Menlo", "Meslo LG", "Microsoft Yahei", monospace;
      font-weight: 400;
    }

    i {
      font-style: normal;
      letter-spacing: 2px;
    }

    iframe {
      width: 90%;
      height: 630px;
      margin: auto;
      display: block;
    }

    ul {
      list-style: none;
      text-align: center;
      padding: 20px;
      width: 80%;
      margin: auto;
    }

    li {
      text-align: center;
      display: inline-block;
      padding: 5px 15px;
    }

    li.selected {
      color:rgb(255, 99, 132);
    }
   
    li:hover {
      color:rgb(255, 99, 132);
      transition: color 0.3s linear, background-color 0.3s linear;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .without {
      text-decoration: line-through;
    }

    #nav {
      width: 80%;
    }

    #nav a:hover {
      border-bottom: #000 dotted 1px;
    }

    #types li, #nav li{
      cursor: pointer;
    }

    #mask {
      background: #fff;
      opacity: 0.5;
      display: none;
      align-items:center;
      justify-content:center;
      font: 48px;
      font-weight: bold;

      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #gene {
      display: none;
      width: 80%;
      margin: auto;
      margin-bottom: 50px;
      text-transform: uppercase;
    }

    #gene .title {
      padding: 20px 10px 10px;
      margin-bottom: 30px;
      border-bottom: #000 dotted 1px;
    }

    #gene .title .close {
      float: right;
    }

    #gene .title .close:after {
      content: "";
      clear: both;
      display: block;
    }

    #gene .data {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 10px;
    }

    #gene .data .section{
      width: 340px;
    }

    #gene .data ul {
      /* padding: 20px 0px; */
      text-align: left;
      width: 100%;
    }

    #gene .data li {
      display: block;
      text-align: left;
    }

    .tooltip {
      background: #FFC107;
      color: #fff;
      width: auto;
      /* max-width: 70%; */
      box-shadow: none;
    }

    .tooltip .table {
      font-size: 12px;
      margin-top: 10px;
    }

    .tooltip .table th {
      min-width: 100px;
    }    

    .tooltip .table .tbody {
      font-weight: 300;
    }

    .toast-title, .toast-message {
      font-size: 12px;
    }

    .toast-message {
      padding-top: 5px;
    }

    .cursor-pointer {
      cursor: pointer;
    }

    .cursor-default {
      cursor: default;
    }

    .cursor-wait {
      cursor: wait;
    }

    .cursor-light {
      opacity: 0.5;
    }

  </style>
</head>
<body>
  <div id="mask"> Walle Stock Market </div>
  <ul id="switch">
    <li id="today-trace"  class="selected"><a href="?mode=today-trace">今日数据</a></li>
    <li id="daily-trace"><a href="?mode=daily-trace">近期跟踪</a></li>
    <li id="history-trace"><a href="?mode=history-trace">历史数据</a></li>
  </ul>
  <ul id="types"></ul>
  <ul id="nav"></ul>
  <iframe id="charts" src="" frameborder="0" scrolling="no"></iframe>
  <div id="gene" name="gene"></div>

  <script id="gene-template" type="text/x-handlebars-template">
    <p class="title"> 股票基因 - <a href="http://data.eastmoney.com/zjlx/{{code}}.html" target="_blank"> {{name}} ({{code}}) </a> <i class="cursor-pointer close" onclick="hideGene()">x</i></p>
    <div class="data" >
      {{#each gene}}
        <div class="section">
          <span class="name">{{@key}}</span>
          <ul>
            {{#each this}}
              <li>{{@key}}: {{this}}</li>
            {{/each}}
          </ul> 
        </div> 
      {{/each}} 

      <!-- Flex 填充三个0高度的项目 以保证最后一行左对齐填充 -->
      <div class="section"></div>
      <div class="section"></div>
      <div class="section"></div>
    </div>
  </script>

  <script>
    var geneTimeoutId = -1

    function compile(templateSelector, destSelector, data) {
      var templateEl = document.querySelector(templateSelector)
      var destEl = document.querySelector(destSelector)
      var template = Handlebars.compile(templateEl.innerHTML);
      destEl.innerHTML = template(data)
    }

    async function showGene(code) {
      var gene = await window.__Walle_Stock_Pool.gene(code)
      compile('#gene-template', '#gene',gene)
      document.querySelector('#gene').style.display = 'block'

      // 自动滚动到基因数据
      const top = document.querySelector('#gene').offsetTop
      window.scrollTo(0, top)
      
      // 自动收起隐藏
      clearTimeout(geneTimeoutId)
      geneTimeoutId = setTimeout(hideGene, 20*60*1000)
    }

    function hideGene() {
      clearTimeout(geneTimeoutId)
      window.scrollTo(0, 0)
      document.querySelector('#gene').style.display = 'none'
    }

    // dev use 
    // setTimeout(() => showGene('600519'), 3000)
    // setTimeout(() => showGene('603489'), 3000)
  </script>

  <script>
    var mode = url('?mode') || 'today-trace'
    var collections = {
      // 访问地址 ?mode=history-trace-with-limit-up-sotcks
      // 捕获榜单包含涨停股 但无法买入操作 追踪数据计算收益有偏差(偏大很多)
      'history-trace-with-limit-up-sotcks': './collections/history-trace-with-limit-up-stocks/',
      // 访问地址 ?mode=history-trace-without-limit-up-sotcks
      // 捕获榜单不包含涨停股 接近实际买入操作
      'history-trace-without-limit-up-sotcks': './collections/history-trace-without-limit-up-stocks/',

      'history-trace': './collections/history-trace/',
      'daily-trace': './collections/daily-trace/',
    }
    var dailyListsChange = {}
    var dailyListsCapture = {}

    var dailyListsChangeMap = {
      // [09:40]: { ...dailyListsChange },
      // [14:40]: { ...dailyListsChange },
    }
    var dailyListsCaptureMap = {
      // [09:40]: { ...dailyListsCapture },
      // [14:40]: { ...dailyListsCapture },
    }
    var dailyListsRecentMap = {
      // [1w-09:40]: { ...dailyListsRecent },
      // [1w-14:40]: { ...dailyListsRecent },
    }
    var dailyListsRecentNames = []

    var mask = document.getElementById('mask')
    var iframe = document.getElementById('charts')
    var interval = 0
    var toolTip = null

    var config = {}
    var captureTimeSelected = ''
    var dailyNavSelected = ''
    
    // 前两个交易日数据
    var last1dayChanges = {}
    var last2dayChanges = {}

    var isDev = location.host.includes('localhost') || location.host.includes('127.0.0.1')

    function showMask(msg) {
      mask.style.display = 'flex'
      msg && (maks.innerHTML = msg)
    }

    function hideMask() {
      mask.style.display = 'none'
    }

    async function initWalleStockDevTool() {    
      if (!window.__Walle_Stock_Interval_Capture_Start) { return }
      
      if ( isDev ) {
        // dev use , 2 mins 
        interval = window.__Walle_Stock_Interval_Capture_Start( 2 * 60 )
      } else {
        // production use , default 5 min
        interval = window.__Walle_Stock_Interval_Capture_Start()
      }
    }

    async function initWalleStockData() {
      var date = moment().format('YYYYMMDD')
      
      // 保留前一周交易日数据 用于复盘分析
      // var lastdate = moment().subtract(1, 'day').format('YYYYMMDD')
      var lastdate = moment().subtract(10, 'days').format('YYYYMMDD')

      localStorage.removeItem(`localforage/__Walle_Stock_Daily_Trace_${lastdate}`)
      localStorage.removeItem(`localforage/__Walle_Stock_Daily_Capture_${lastdate}`)

      var sdailyListsChange = await localStorage.getItem(`localforage/__Walle_Stock_Daily_Trace_${date}`) 
      if (sdailyListsChange) {
        dailyListsChangeMap = JSON.parse(sdailyListsChange)
      }

      var sTodayCaptureLists = await localStorage.getItem(`localforage/__Walle_Stock_Daily_Capture_${date}`) 
      if (sTodayCaptureLists) {
        dailyListsCaptureMap = JSON.parse(sTodayCaptureLists)
      }
      
      switchDataWithCaptureTime()
      if (dailyListsChangeMap[captureTimeSelected]) {
        buildTodayNav()
        hideMask()
      }

      console.log('@initWalleStockDevTool@ Trace ', dailyListsChangeMap)
      console.log('@initWalleStockDevTool@ Capture ', dailyListsCaptureMap)
      console.log('@captureTimeSelected@' , captureTimeSelected)
      console.log('@dailyNavSelected@' , dailyNavSelected)

      isDev &&  hideMask()
    }

    function onSwitchToday() {
      showMask()
      iframe.src=`./charts.html?mode=today-trace`
      iframe.onload = initWalleStockData

      if ( isDev ) {
        // debug use 
        injectScript(`${location.origin}/walle-stock.min.js`,initWalleStockDevTool)
      } else {
        // production use 
        injectScript('../walle-stock.min.js',initWalleStockDevTool)
      }

      window.addEventListener('__Walle_Stock_Daily_Capture_Event', async function ({ detail }) {
        console.log('#__Walle_Stock_Daily_Capture_Event# ', detail)
        var date = moment().format('YYYYMMDD')

        var captureTime = detail.time
        dailyListsCaptureMap[captureTime] = detail.lists 
        await localStorage.setItem(`localforage/__Walle_Stock_Daily_Capture_${date}`, JSON.stringify(dailyListsCaptureMap))

        switchDataWithCaptureTime()
        buildTodayNav()
        hideMask()
      })

      window.addEventListener('__Walle_Stock_Daily_Trace_Event', async function ({ detail }) {
        var time = moment().format('HH:mm:ss')
        var date = moment().format('YYYYMMDD')
        console.log('#__Walle_Stock_Daily_Trace_Event# ', time, detail)

        var captureTime = detail.time
        // every day reset dailyListsChange
        if (dailyListsChangeMap.date !== date) {
          dailyListsChangeMap = { date }
        }

        if (!dailyListsChangeMap[captureTime]) {
          dailyListsChangeMap[captureTime] = {
            changes: {},
            newlists: {},
            oldlists: {},
          }
        }

        var data = detail.changes
        var keys = Object.keys(data)
        for (var list_name of keys) {
          var value = data[list_name]

          if (!dailyListsChangeMap[captureTime].changes[list_name]) { 
            dailyListsChangeMap[captureTime].changes[list_name] = {
              time: [time],
              data: [value]
            }
          } else {
            dailyListsChangeMap[captureTime].changes[list_name].time.push(time)
            dailyListsChangeMap[captureTime].changes[list_name].data.push(value)
          }
        }

        dailyListsChangeMap[captureTime].newlists = detail.newlists
        dailyListsChangeMap[captureTime].oldlists = detail.oldlists

        console.log(`#__Walle_Stock_Daily_Trace_${date}# `, dailyListsChangeMap)
        await localStorage.setItem(`localforage/__Walle_Stock_Daily_Trace_${date}`, JSON.stringify(dailyListsChangeMap))

        switchDataWithCaptureTime()
        buildTodayNav()
        hideMask()
      }) 
    }

    function onChangeTodayCharts(name) {
      if (!dailyListsChange) { 
        // clear chart
        if(iframe.contentWindow.window.__Walle_Charts_Callback) { 
          iframe.contentWindow.window.__Walle_Charts_Callback({ time:[], data: [] })
        }
        return 
      }

      dailyNavSelected = name
      var nav = document.getElementById('nav')
      
      var liSelected = document.querySelector('#nav li.selected')
      if (liSelected) { liSelected.removeAttribute('class') }
      var el = document.querySelector(`#nav li[name="${name}"]`)
      el && el.setAttribute('class', 'selected')

      var chartsData = dailyListsChange.changes[dailyNavSelected]
      if (!captureTimeSelected.startsWith('t0')) { 
        // 合并展示两日追踪数据 以便数据分析 
        // 即 2019-11-19日 09:40 图表数据包括: 2019-11-18 T0-09:40 + 2019-11-19 09:40
        var captureTime = 't0-' + captureTimeSelected
        if ( last1dayChanges[captureTime] && last1dayChanges[captureTime].changes) {
          var last1dayChangesData = last1dayChanges[captureTime].changes[dailyNavSelected]
          var todayChangesData = dailyListsChange.changes[dailyNavSelected]

          var time = [].concat(last1dayChangesData.time || [], todayChangesData.time || [])
          var data = [].concat(last1dayChangesData.data || [], todayChangesData.data || [])
          
          chartsData = { time, data }
        }
      }

      console.log('#call __Walle_Charts_Callback# ', captureTimeSelected, dailyNavSelected, chartsData)
      iframe.contentWindow.window.__Walle_Charts_Callback(chartsData)
    }

    function onClickIgnoreStock(el, list_name, code, name) {
      if(!captureTimeSelected.startsWith('t0')) { return }

      const isIgnore = window.confirm(`Ignore Stock ${code} ${name}?`)
      if (isIgnore) {
        // remove 't0-'
        const time = captureTimeSelected.slice(3)
        console.log(`#__Walle_Stock_Controller# ignore `, time, list_name, code, name)
        window.__Walle_Stock_Controller.ignore(time, list_name, code)

        // 清空当日追踪榜单数据中的对应股票 保留捕获榜单中的数据
        delete dailyListsChange.newlists[list_name][code]

        // 清空此股票 tr 行
        el.parentNode.parentNode.innerHTML = ''
      }
    }

    function createStocksTable(list, name, isCaptureList = false) {
      var translator = {
        code: '股票代码',
        name: '股票简称',
        price: '股价',
        change: '涨跌幅',
        rate: '主力净占比',
        open: '开盘价',
        turnover: '换手率',
        qrr: '量比',
        volume: '成交量',
        inflow: '主力流入资金',
        outflow: '主力流出资金',
        netinflow: '主力净流入资金',
        // 非固定属性
        hot: '热度',
      }

      if (!list[name]) { return }

      var stockCodes = Object.keys(list[name])
      if (!stockCodes.length) { return }

      var testStock = list[name][stockCodes[0]]
      var thead = `<thead><tr>`
      for (var key in translator) {
        if (key === 'hot' && !testStock.hot) { continue }
        thead += `<th scope="col">${translator[key]}</th>`
      }
      thead += '</tr></thead>'

      var tbody = `<tbody>`
      for (var code of stockCodes) {
        var stock = list[name][code]
        tbody += `<tr>`
        for (var field in translator ) {
          if (field === 'hot' && !testStock.hot) { continue }

          var value = stock[field]
          if (['inflow', 'outflow', 'netinflow'].includes(field)) {
            if (Math.abs(+value) >= 100000000) {
              value = (+value/100000000).toFixed(2) + '亿'
            } else {
              value = (+value/10000).toFixed(2) + '万'
            } 
          }

          if (!name.includes('上证指数') && (field === 'code')) {
            if (!isCaptureList) {
              if (captureTimeSelected.startsWith('t0')) {
                // 仅可忽略今日捕获的榜单股票
                var x = `<i class="cursor-pointer" title="从榜单中移除此股票" onclick="onClickIgnoreStock(this, '${name}' , '${stock.code}', '${stock.name}')">(x)</i>`
                tbody += `<th scope="row" class="cursor-default">${value} ${x}</th>`
                continue
              }
            } else {
              var i = `<i class="cursor-pointer" title="查看股票基因数据" onclick="showGene('${stock.code}')">(i)</i>`
              tbody += `<th scope="row" class="cursor-default">${value} ${i}</th>`
              continue
            }
          }

          tbody += `<th scope="row" class="cursor-default" >${value}</th>`
        }

        tbody += '</tr>'
      }  
      tbody += `</tbody>`

      table = '<table class="table">' + thead + tbody + '</table>'

      return table
    }

    async function onShowTodayCharts(el, name, isTodayCaptureList = false) {
      var title = ''

      if (isTodayCaptureList) {
        if(!dailyListsCapture) { return }

        if(dailyListsCapture[name]) {
          // 今日捕获数据
          var listTable = createStocksTable(dailyListsCapture, name, true)
          if (listTable) {
            title = `捕获${listTable}`
          }
        }    
      } else {
        if (!dailyListsChange) { return }

        var newListTable = createStocksTable(dailyListsChange.newlists, name)
        var oldListTable = createStocksTable(dailyListsChange.oldlists, name, true)

        // T0 当日追踪榜单 从Capture数据显示 以便Interval榜单可以实时显示捕获数据
        if (captureTimeSelected.startsWith('t0') && dailyListsCapture) { 
          oldListTable = createStocksTable(dailyListsCapture, name, true)
        }
        
        if (captureTimeSelected && captureTimeSelected.startsWith('t0')) {          
          newListTable && (title += `跟踪${newListTable}`)
          oldListTable && (title += `<br/>捕获${oldListTable}`)
        } else {
          newListTable && (title += `今日${newListTable}`)
          oldListTable && (title += `<br/>昨日${oldListTable}`)
        }
      }

      if (title) {
        toolTip && toolTip.dispose()
        toolTip = new Tooltip(el, {
          title,
          html: true,
          trigger: "click",
          closeOnClickOutside: true,

          // hover related
          // trigger: "hover",
          // delay: { show: 1000, hide: 300 },

          popperOptions: {
            placement: 'bottom',
            modifiers: {
              preventOverflow: {
                boundariesElement: document.querySelector('body'),
              },
            },
          },
        });
      }

      return false
    }

    function indicatorOfTodayNav(time, name) {
      if (!captureTimeSelected.startsWith('t0')) { return ''}

      if (last1dayChanges[time] && last2dayChanges[time]) {
        if (last1dayChanges[time].changes && last2dayChanges[time].changes) {
          if (last1dayChanges[time].changes[name] && last2dayChanges[time].changes[name]) {
            const last1dayChange = +last1dayChanges[time].changes[name].data.slice(-1)
            const last2dayChange = +last2dayChanges[time].changes[name].data.slice(-1)

            const last1date = last1dayChanges.date
            const last2date = last2dayChanges.date

            // 连续两日榜单追踪为下跌则标记为不买入
            if (last1dayChange < 0 && last2dayChange < 0) {
              return `<i title="前两交易日跟踪收益 \r\n${last2date} : ${last2dayChange}%, ${last1date} : ${last1dayChange}%">✘</i>`
            } else {
              return `<i title="前两交易日跟踪收益 \r\n${last2date} : ${last2dayChange}%, ${last1date} : ${last1dayChange}%">✔</i>`
            }
          }
        }
      }

      return ''
    }

    async function buildTodayNav() {
      var nav = document.getElementById('nav')
      if ((!dailyListsChange && !dailyListsCapture)) { 
        nav.innerHTML = ''
        onChangeTodayCharts()
        return 
      }

      var lists = dailyListsChange ? dailyListsChange.changes : dailyListsCapture
      var names = Object.keys(lists)
      var changes = dailyListsChange ? dailyListsChange.changes : {}

      var shtml = ''
      for (var name of names) {
        if (name === '跌幅榜' || name === '上证指数') { continue }
  
        var ptcchange = changes[name] ? changes[name].data.slice(-1) : '0.00'
        var text = (name.slice(-1) === '榜') ? name.slice(0, -1): name

        shtml += `<li name="${name}" >
          <a>${indicatorOfTodayNav(captureTimeSelected, name)}</a>
          <a onclick="onChangeTodayCharts('${name}')">${text.toUpperCase()}</a>
          (<a onmouseover="onShowTodayCharts(this, '${name}', ${!dailyListsChange})">${ptcchange}%</a>)
          </li>`
      }

      if (lists['上证指数']) {
        var index_ptcchange = changes[name] ? changes['上证指数'].data.slice(-1) : '0.00'
        shtml = `<li name="上证指数" >
        <a onclick="onChangeTodayCharts('上证指数')" >上证指数</a>
        (<a onmouseover="onShowTodayCharts(this, '上证指数', ${!dailyListsChange})">${index_ptcchange}%</a>)
        </li>` + shtml
      }

      nav.innerHTML = shtml

      var defaultSeleted = nav.querySelector('li').getAttribute('name')
      var isExistCurSelected = dailyNavSelected && nav.querySelector(`li[name="${dailyNavSelected}"]`)
      onChangeTodayCharts(isExistCurSelected ? dailyNavSelected : defaultSeleted)
    }

    function onSwitch() {
      var liSelected = document.querySelector('#switch li.selected')
      if (liSelected) { liSelected.removeAttribute('class') }
      var el = document.querySelector(`#switch #${mode}`)
      if(el ) { el.setAttribute('class', 'selected') }

      (mode === 'today-trace') ? onSwitchToday() : onSwitchDailyOrHistory()
    }

    function onSwitchDailyOrHistory() {
      var collectionJs = `${collections[mode]}/index.js`
      injectScript(collectionJs)
    }

    async function onChangeDailyOrHistoryCharts(list_name) {
      if (!list_name) { 
        // clear chart
        if(iframe.contentWindow.window.__Walle_Charts_Callback) { 
          iframe.contentWindow.window.__Walle_Charts_Callback({ time:[], data: [] })
        }
        return 
      }

      if (captureTimeSelected.includes('w1')) {        
        iframe.src=`./charts.html`
        iframe.onload = () => {
          iframe.contentWindow.window.__Walle_Charts_Callback(dailyListsRecentMap[captureTimeSelected][list_name])
        }
      } else {
        if (!list_name.includes('w1')) {
          await new Promise((resolve) => {
            iframe.src=`./charts.html?name=${list_name}&collection=${collections[mode]}`
            iframe.onload = resolve
          }) 
        }
      }

      var nav = document.getElementById('nav')
      
      var liSelected = document.querySelector('#nav li.selected')
      if (liSelected) { liSelected.removeAttribute('class') }
      document.querySelector(`#nav li[name="${list_name}"]`).setAttribute('class', 'selected')
    }

    async function buildDailyOrHistoryNav(names) {
      var nav = document.getElementById('nav')
      var nameOfIndex = '上证指数'
      var isExistIndex = false 

      nav.style.display = 'none'

      var shtml = ''
      for (var name of names) {
        if (name.includes('跌幅榜')) { continue }

        var text = (name.slice(-1) === '榜') ? name.slice(0, -1): name
        var sli = `<li onclick="onChangeDailyOrHistoryCharts('${name}')" name="${name}" >${text.toUpperCase()}</li>`

        // 上证指数在第一位
        if (name.includes('上证指数')) {
          nameOfIndex = name
          shtml = sli + shtml

          isExistIndex = true
        } else {
          shtml += sli
        }
      }

      if (!isExistIndex) {
        shtml = `<li onclick="onChangeDailyOrHistoryCharts('${nameOfIndex}')" name="${nameOfIndex}" >上证指数</li>` + shtml
      }

      nav.innerHTML = shtml
      if (mode !== 'daily-trace') {
        nav.style.display = 'block'
      }

      var defaultSeleted = nav.querySelector('li').getAttribute('name')
      await onChangeDailyOrHistoryCharts(defaultSeleted)
    }

    async function buildDailyNav() {
      var nav = document.getElementById('nav')
      var lis = document.querySelectorAll('#nav li') 
      var defaultSeleted = ''

      if (!lis.length) { return }

      for(var li of lis) {
        var name = li.getAttribute('name')
        var time1 = captureTimeSelected.replace(':','')
        var time2 = name.split('@')[0]
        if (time1 === time2) {
          li.style.display = 'inline-block'
          
          // 0940@上证指数 => 上证指数
          if(li.innerText.includes('@')) {
            var text = li.innerText.split('@')[1]
            li.innerText = (text.slice(-1) === '榜') ? text.slice(0, -1): text
          }

          if (name.includes('上证指数')) {
            defaultSeleted = name
          }
        } else {
          li.style.display = 'none'
        }
      }
      
      nav.style.display = 'block'
      await onChangeDailyOrHistoryCharts(defaultSeleted)
    }
    
    window.__Walle_Stocks_Callback = async function (data) {
      var names = data.names.split(',')

      if (mode === 'daily-trace') {
        names = names.concat(dailyListsRecentNames)
        await buildDailyOrHistoryNav(names)
        await buildDailyNav()
      } else {
        await buildDailyOrHistoryNav(names)
      }
    }

    function injectScript(src, cb) { 
			var e = document.createElement('script'); 
			e.type = 'text/javascript'; 
      e.src = src; 
      e.onload = cb
			document.body.appendChild(e) 
		}

    function initHistoryTypeNav() {
      var nav = document.getElementById('types')

      var sHtml = ``
      if (mode === 'history-trace') {
        sHtml += `<li class="selected"><a href="?mode=history-trace">组合</a></li>`
      } else {
        sHtml += `<li><a href="?mode=history-trace">组合</a></li>`
      }
      
      if (mode === 'history-trace-without-limit-up-sotcks') {
        sHtml += `<li class="selected"><a class="without" href="?mode=history-trace-without-limit-up-sotcks" >10%</a></li>`
      } else {
        sHtml += `<li><a class="without" href="?mode=history-trace-without-limit-up-sotcks" >10%</a></li>`
      }

      if (mode === 'history-trace-with-limit-up-sotcks') {
        sHtml += `<li class="selected"><a class="with" href="?mode=history-trace-with-limit-up-sotcks" >10%</a></li>`
      } else {
        sHtml += `<li><a class="with" href="?mode=history-trace-with-limit-up-sotcks" >10%</a></li>`
      }
      
      nav.innerHTML = sHtml
    }

    async function initTimesNav() {
      if (!config) { return }

      var nav = document.getElementById('types')
      const rules = [].concat(config.captures || [], config.intervals || [])

      var sHtml = ''
      var sT0Html = ''
      var sW1Html = ''
      for(var rule of rules) {
        sHtml += `<li onclick="onChangeTimesNav(this)">${rule.capture.toUpperCase()}</li>`
        sT0Html += `<li onclick="onChangeTimesNav(this)">T0-${rule.capture.toUpperCase()}</li>`
        sW1Html += `<li onclick="onChangeTimesNav(this)">W1-${rule.capture.toUpperCase()}</li>`
      }

      if (mode === 'today-trace') {
        nav.innerHTML = sHtml + sT0Html
      } else if (mode === 'daily-trace') {
        nav.innerHTML = sHtml + sW1Html
      } else {
        nav.innerHTML = sHtml
      }

      onChangeTimesNav(document.querySelector('#types li:first-child'))
    }

    function onChangeTimesNav(el) {
      if (!el) { return }

      var lis = document.querySelectorAll('#types li')
      for(var li of lis) {
        li.removeAttribute('class', 'selected')
      }

      el.setAttribute('class', 'selected')

      captureTimeSelected = el.innerText.toLowerCase()
      switchDataWithCaptureTime()

      ;(mode === 'today-trace') ? buildTodayNav() : buildDailyNav()
    }

    function switchDataWithCaptureTime() {
      if (captureTimeSelected.startsWith('t0')) {
        // remove 't0-'
        dailyListsCapture = dailyListsCaptureMap[captureTimeSelected.slice(3)]
      } else {
        dailyListsCapture = undefined
      }

      dailyListsChange = dailyListsChangeMap[captureTimeSelected]
    }

    async function loadRecentRecord() {
      const rules = [].concat(config.captures || [], config.intervals || [])

      // recent 1 week record
      for (let i = 1; i <= 10; i++) {
        var date = moment().subtract(i, 'days').format('YYYYMMDD')
        var day = moment().subtract(i, 'days').day()
        var key = `localforage/__Walle_Stock_Daily_Trace_${date}`

        // 跳过周末
        if ([6, 0].includes(day)) {
          continue
        }
        
        var sDailyTraceChanges = await localStorage.getItem(key) 
        if (!sDailyTraceChanges) {
          continue
        }

        var dailyTraceChanges = JSON.parse(sDailyTraceChanges)
        for(var rule of rules) {
          var captureTime = rule.capture
          if (!dailyTraceChanges[captureTime]) {
            continue
          }

          var dailyChanges = dailyTraceChanges[captureTime].changes
          for(var name in dailyChanges) {
            var listChanges = dailyChanges[name]

            var name = `w1-${captureTime}@${name}`.replace(':','')
            if (!dailyListsRecentNames.includes(name)) {
              dailyListsRecentNames.push(name)
            }

            var time = 'w1-' + captureTime
            if (!dailyListsRecentMap[time]) {
              dailyListsRecentMap[time] = {}
            }
            if (!dailyListsRecentMap[time][name]) {
              dailyListsRecentMap[time][name] = {
                'daily-close-ptcchange': [],
                'daily-close-profit': [],
                'daily-open-ptcchange': [],
                'daily-open-profit': [],	
              }
            }
            var recentChanges = dailyListsRecentMap[time][name]

            var open = listChanges.data.shift() || 0
            var close = listChanges.data.pop() || 0
            var closeProfit = recentChanges['daily-close-profit'][1] || 0
            var openProfit = recentChanges['daily-open-profit'][1] || 0

            closeProfit += +close
            openProfit += +open

            recentChanges['daily-close-profit'].unshift(+date, +closeProfit)
            recentChanges['daily-open-profit'].unshift(+date, +openProfit)
            recentChanges['daily-close-ptcchange'].unshift(+date, +close)
            recentChanges['daily-open-ptcchange'].unshift(+date, +open) 
          }
        }
      }
    }

    async function loadConfig() {
      try {
        // load config 
        var sConfig = await localStorage.getItem(`localforage/__Walle_Stock_Bot_Config`) 
        config = JSON.parse(sConfig)

        // load last 2 trade days data 
        var last1day = moment().subtract(1, 'day').format('YYYYMMDD')
        var last2day = moment().subtract(2, 'days').format('YYYYMMDD')
        // 周一前两个工作日为上周周四、周五
        if (+moment().day() === 1) {
          last1day = moment().subtract(3, 'days').format('YYYYMMDD')
          last2day = moment().subtract(4, 'days').format('YYYYMMDD')
        } else if (+moment().day() === 2) {
          last2date = moment().subtract(4, 'days').format('YYYYMMDD')
        }

        var sLast1dayChanges = await localStorage.getItem(`localforage/__Walle_Stock_Daily_Trace_${last1day}`) 
        var sLast2dayChanges = await localStorage.getItem(`localforage/__Walle_Stock_Daily_Trace_${last2day}`) 
      
        sLast1dayChanges && (last1dayChanges = JSON.parse(sLast1dayChanges));
        sLast2dayChanges && (last2dayChanges = JSON.parse(sLast2dayChanges));
      } catch (e) {
        // first time load config data not loaded, reload.
        setTimeout(() => location.reload(), 1000) 
      }
    }

    window.onload = async function() {
      await loadConfig()

      if (mode === 'daily-trace') {
        await loadRecentRecord()
      }

      if (['daily-trace', 'today-trace'].includes(mode)) {
        initTimesNav()
      } else {
        initHistoryTypeNav()
      }

      onSwitch()
    }
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-20407881-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-20407881-3');
  </script>
</body>
</html>